name: CI/CD Pipeline

# ============================================================================
# å¿…éœ€çš„ Secrets é…ç½®
# ============================================================================
# Organization Secrets (ç»„ç»‡çº§åˆ«ï¼Œå…±äº«é…ç½®):
#   ServerB: SVRB_HOST, SVRB_USERNAME, SVRB_SSH_KEY, SVRB_SSH_PORT
#   SVRB_SUDO_PASSWORD (å¯é€‰ï¼Œå¦‚æœ sudo éœ€è¦å¯†ç )
#   DOCKERHUB_USERNAME, DOCKERHUB_TOKEN (å¯é€‰ï¼Œå¦‚æœä½¿ç”¨ Docker Hub)
#   æ³¨æ„ï¼šæ ¹æ®æ¶æ„æ–‡æ¡£ï¼Œå‰ç«¯åªéƒ¨ç½²åˆ° ServerBï¼Œä¸éœ€è¦ ServerA çš„é…ç½®
#
# Repository Secrets (ä»“åº“çº§åˆ«ï¼Œæ•æ„Ÿä¿¡æ¯):
#   WWW_UID, WWW_GID (å¯é€‰ï¼Œé»˜è®¤ 1000/1000)
#   DEPLOY_PATH_SERVERB (å¯é€‰ï¼Œé»˜è®¤ /opt/qs-ops)
#   æ³¨æ„ï¼šæ ¹æ®æ¶æ„æ–‡æ¡£ï¼Œå‰ç«¯åªéƒ¨ç½²åˆ° ServerBï¼Œä¸éƒ¨ç½²åˆ° ServerA
# ============================================================================

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
    inputs:
      deploy:
        description: "æ˜¯å¦éƒ¨ç½²åˆ° ServerBï¼ˆåªå…è®¸ main åˆ†æ”¯ï¼‰"
        required: false
        type: boolean
        default: false

# å…³é”®ï¼šæ¨ GHCR éœ€è¦ packages: write
permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE: ghcr.io/fangcunmount/qs-operating-system
  DOCKERFILE: build/Dockerfile

jobs:
  # 1) Test + Lintï¼ˆæ‰€æœ‰åˆ†æ”¯/PR éƒ½è·‘ï¼‰
  ci:
    name: Test & Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18.x"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test -- --coverage --watchAll=false --passWithNoTests

      - name: Run ESLint
        run: npx eslint . --ext .ts,.tsx,.js,.jsx --max-warnings 0

  # 2) Docker build & pushï¼ˆä»… main push æˆ–æ‰‹åŠ¨è§¦å‘ï¼‰
  docker-build:
    name: Build & Push Docker Image (GHCR)
    needs: [ci]
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sanity check Dockerfile path
        run: |
          ls -la build
          test -f "${DOCKERFILE}" || (echo "Dockerfile not found at ${DOCKERFILE}" && exit 1)

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # æ¨ GHCRï¼šç”¨ GITHUB_TOKEN å°±å¤Ÿï¼ˆé…åˆ packages:writeï¼‰
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags/labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.IMAGE }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=ref,event=branch
            type=sha,format=short

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ env.DOCKERFILE }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # 3) Deploy ServerBï¼ˆä»… main åˆ†æ”¯ï¼špush è‡ªåŠ¨éƒ¨ç½²ï¼›dispatch éœ€ deploy=trueï¼‰
  deploy-serverb:
    name: Deploy to ServerB
    needs: [docker-build]
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy via SSH
        env:
          HOST: ${{ secrets.SVRB_HOST }}
          USER: ${{ secrets.SVRB_USERNAME }}
          PORT: ${{ secrets.SVRB_SSH_PORT || 22 }}
          SUDO_PASSWORD: ${{ secrets.SVRB_SUDO_PASSWORD }}
          IMAGE: ghcr.io/fangcunmount/qs-operating-system
        run: |
          set -Eeuo pipefail

          SSH_OPTS="-p ${PORT} -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
          echo "ğŸ”Œ Connecting to ${USER}@${HOST}:${PORT}"

          ssh ${SSH_OPTS} "${USER}@${HOST}" 'bash -s' <<'EOF'
          set -Eeuo pipefail

          CONTAINER_NAME="qs-operating-system"
          NETWORK_NAME="infra-network"
          IMAGE_NAME="${IMAGE}:latest"

          # SUDO helper
          if sudo -n true 2>/dev/null; then
            SUDO="sudo"
          else
            if [ -z "${SUDO_PASSWORD:-}" ]; then
              echo "âŒ sudo needs password but SVRB_SUDO_PASSWORD not set" >&2
              exit 1
            fi
            sudo_pw() { sudo -S "$@" <<<"$SUDO_PASSWORD"; }
            export -f sudo_pw
            SUDO="sudo_pw"
            $SUDO -v || true
          fi

          echo "ğŸ“¥ Pull image: ${IMAGE_NAME}"
          $SUDO docker pull "${IMAGE_NAME}"

          if ! $SUDO docker network ls --format '{{.Name}}' | grep -q "^${NETWORK_NAME}$"; then
            echo "âŒ Network ${NETWORK_NAME} not found. Create it first:"
            echo "   docker network create ${NETWORK_NAME}"
            exit 1
          fi

          if $SUDO docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
            $SUDO docker stop "${CONTAINER_NAME}" || true
            $SUDO docker rm "${CONTAINER_NAME}" || true
          fi

          echo "ğŸš€ Run container: ${CONTAINER_NAME}"
          $SUDO docker run -d \
            --name "${CONTAINER_NAME}" \
            --network "${NETWORK_NAME}" \
            --restart unless-stopped \
            -p 3000:3000 \
            "${IMAGE_NAME}"

          echo "âœ… Done. Current status:"
          $SUDO docker ps --filter "name=${CONTAINER_NAME}" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          EOF 