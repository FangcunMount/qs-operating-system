name: CI/CD Pipeline

# ============================================================================
# å¿…éœ€çš„ Secrets é…ç½®
# ============================================================================
# Organization Secrets (ç»„ç»‡çº§åˆ«ï¼Œå…±äº«é…ç½®):
#   ServerB: SVRB_HOST, SVRB_USERNAME, SVRB_SSH_KEY, SVRB_SSH_PORT
#   SVRB_SUDO_PASSWORD (å¯é€‰ï¼Œå¦‚æžœ sudo éœ€è¦å¯†ç )
#   DOCKERHUB_USERNAME, DOCKERHUB_TOKEN (å¯é€‰ï¼Œå¦‚æžœä½¿ç”¨ Docker Hub)
#   æ³¨æ„ï¼šæ ¹æ®æž¶æž„æ–‡æ¡£ï¼Œå‰ç«¯åªéƒ¨ç½²åˆ° ServerBï¼Œä¸éœ€è¦ ServerA çš„é…ç½®
#
# Repository Secrets (ä»“åº“çº§åˆ«ï¼Œæ•æ„Ÿä¿¡æ¯):
#   WWW_UID, WWW_GID (å¯é€‰ï¼Œé»˜è®¤ 1000/1000)
#   DEPLOY_PATH_SERVERB (å¯é€‰ï¼Œé»˜è®¤ /opt/qs-ops)
#   æ³¨æ„ï¼šæ ¹æ®æž¶æž„æ–‡æ¡£ï¼Œå‰ç«¯åªéƒ¨ç½²åˆ° ServerBï¼Œä¸éƒ¨ç½²åˆ° ServerA
# ============================================================================

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
    inputs:
      deploy:
        description: "æ˜¯å¦éƒ¨ç½²åˆ° ServerBï¼ˆåªå…è®¸ main åˆ†æ”¯ï¼‰"
        required: false
        type: boolean
        default: false

# å…³é”®ï¼šæŽ¨ GHCR éœ€è¦ packages: write
permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE: ghcr.io/fangcunmount/qs-operating-system
  DOCKERFILE: build/Dockerfile

jobs:
  test_lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "18.x"
          cache: "npm"

      - run: npm ci

      - name: Test
        run: npm test -- --coverage --watchAll=false --passWithNoTests || true

      - name: Lint
        run: npx eslint . --ext .ts,.tsx,.js,.jsx --max-warnings 0 || true

  docker_build_push:
    needs: [test_lint]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-buildx-action@v3

      - name: Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & Push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ${{ env.DOCKERFILE }}
          push: true
          tags: |
            ${{ env.IMAGE }}:latest
            ${{ env.IMAGE }}:sha-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy_serverb:
    needs: [docker_build_push]
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == true)
    steps:
      - name: Prepare SSH key
        shell: bash
        env:
          SSH_KEY: ${{ secrets.SVRB_SSH_KEY }}
        run: |
          set -Eeuo pipefail
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # åŽ»æŽ‰ Windows CRLFï¼Œé¿å… key è§£æžå¤±è´¥
          printf '%s\n' "$SSH_KEY" | tr -d '\r' > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keygen -lf ~/.ssh/id_ed25519

      - name: Deploy to ServerB
        shell: bash
        env:
          HOST: ${{ secrets.SVRB_HOST }}
          USER: ${{ secrets.SVRB_USERNAME }}
          PORT: ${{ secrets.SVRB_SSH_PORT || 22 }}
          SUDO_PASSWORD: ${{ secrets.SVRB_SUDO_PASSWORD }}
          IMAGE: ${{ env.IMAGE }}
        run: |
          set -Eeuo pipefail

          SSH_OPTS="-i ~/.ssh/id_ed25519 -p ${PORT} -o BatchMode=yes -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
          echo "ðŸ”Œ Connecting to ${USER}@${HOST}:${PORT}"

          cat <<'REMOTE_SCRIPT' | ssh ${SSH_OPTS} "${USER}@${HOST}" "IMAGE=${IMAGE} SUDO_PASSWORD='${SUDO_PASSWORD}' bash -s"
          set -Eeuo pipefail

          CONTAINER_NAME="qs-operating-system"
          NETWORK_NAME="infra-network"
          IMAGE_NAME="${IMAGE}:latest"

          # sudo helperï¼ˆå…¼å®¹éœ€è¦å¯†ç /ä¸éœ€è¦å¯†ç ï¼‰
          if sudo -n true 2>/dev/null; then
            SUDO="sudo"
          else
            if [ -z "${SUDO_PASSWORD:-}" ]; then
              echo "âŒ sudo éœ€è¦å¯†ç ï¼Œä½†æ²¡æœ‰é…ç½® SVRB_SUDO_PASSWORD" >&2
              exit 1
            fi
            sudo_pw() { sudo -S "$@" <<<"$SUDO_PASSWORD"; }
            export -f sudo_pw
            SUDO="sudo_pw"
            $SUDO -v || true
          fi

          echo "ðŸ“¥ Pull image: ${IMAGE_NAME}"
          $SUDO docker pull "${IMAGE_NAME}"

          # ç½‘ç»œä¸å­˜åœ¨å°±åˆ›å»ºï¼ˆæ¯”ç›´æŽ¥å¤±è´¥æ›´â€œæ”¹å®Œå°±èƒ½è·‘â€ï¼‰
          if ! $SUDO docker network ls --format '{{.Name}}' | grep -q "^${NETWORK_NAME}$"; then
            echo "â„¹ï¸ Network ${NETWORK_NAME} not found, creating..."
            $SUDO docker network create "${NETWORK_NAME}"
          fi

          if $SUDO docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
            $SUDO docker stop "${CONTAINER_NAME}" || true
            $SUDO docker rm "${CONTAINER_NAME}" || true
          fi

          echo "ðŸš€ Run container: ${CONTAINER_NAME}"
          $SUDO docker run -d \
            --name "${CONTAINER_NAME}" \
            --network "${NETWORK_NAME}" \
            --restart unless-stopped \
            -p 3000:3000 \
            "${IMAGE_NAME}"

          echo "âœ… Done. Current status:"
          $SUDO docker ps --filter "name=${CONTAINER_NAME}" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          REMOTE_SCRIPT
