name: CI/CD Pipeline

# ============================================================================
# å¿…éœ€çš„ Secrets é…ç½®
# ============================================================================
# Organization Secrets (ç»„ç»‡çº§åˆ«ï¼Œå…±äº«é…ç½®):
#   ServerB: SVRB_HOST, SVRB_USERNAME, SVRB_SSH_KEY, SVRB_SSH_PORT
#   SVRB_SUDO_PASSWORD (å¯é€‰ï¼Œå¦‚æžœ sudo éœ€è¦å¯†ç )
#   DOCKERHUB_USERNAME, DOCKERHUB_TOKEN (å¯é€‰ï¼Œå¦‚æžœä½¿ç”¨ Docker Hub)
#   æ³¨æ„ï¼šæ ¹æ®æž¶æž„æ–‡æ¡£ï¼Œå‰ç«¯åªéƒ¨ç½²åˆ° ServerBï¼Œä¸éœ€è¦ ServerA çš„é…ç½®
#
# Repository Secrets (ä»“åº“çº§åˆ«ï¼Œæ•æ„Ÿä¿¡æ¯):
#   WWW_UID, WWW_GID (å¯é€‰ï¼Œé»˜è®¤ 1000/1000)
#   DEPLOY_PATH_SERVERB (å¯é€‰ï¼Œé»˜è®¤ /opt/qs-ops)
#   æ³¨æ„ï¼šæ ¹æ®æž¶æž„æ–‡æ¡£ï¼Œå‰ç«¯åªéƒ¨ç½²åˆ° ServerBï¼Œä¸éƒ¨ç½²åˆ° ServerA
# ============================================================================

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:
    inputs:
      deploy:
        description: 'æ˜¯å¦éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ'
        required: false
        type: boolean
        default: false
      server:
        description: 'éƒ¨ç½²åˆ°å“ªä¸ªæœåŠ¡å™¨ï¼ˆå‰ç«¯åªéƒ¨ç½²åˆ° ServerBï¼‰'
        required: false
        type: choice
        options:
          - serverb
        default: 'serverb'

env:
  DOCKER_REGISTRY: ghcr.io
  DOCKER_REPOSITORY: fangcunmount

jobs:
  # ==========================================================================
  # 1) æ ¡éªŒ Secretsï¼ˆåªåœ¨ main åˆ†æ”¯éƒ¨ç½²æ—¶ä¸¥æ ¼è¦æ±‚ï¼‰
  # ==========================================================================

  validate-secrets:
    name: Validate Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Check Required Secrets
        env:
          SVRB_HOST: ${{ secrets.SVRB_HOST }}
          SVRB_USERNAME: ${{ secrets.SVRB_USERNAME }}
          SVRB_SSH_KEY: ${{ secrets.SVRB_SSH_KEY }}
          SVRB_SSH_PORT: ${{ secrets.SVRB_SSH_PORT }}
          SVRB_SUDO_PASSWORD: ${{ secrets.SVRB_SUDO_PASSWORD }}
          WWW_UID: ${{ secrets.WWW_UID }}
          WWW_GID: ${{ secrets.WWW_GID }}
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          echo "ðŸ” Validating GitHub Action secrets..."
          VALIDATION_FAILED=0
          ENFORCE_REQUIRED=0

          if [ "${{ github.ref }}" == "refs/heads/main" ] || [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENFORCE_REQUIRED=1
            echo "ðŸ“‹ Checking required secrets for deployment..."
          else
            echo "â„¹ï¸ Not deploying â€“ required secrets reported for awareness only."
          fi

          # æ ¹æ®æž¶æž„æ–‡æ¡£ï¼Œå‰ç«¯åªéƒ¨ç½²åˆ° ServerB
          REQUIRED_SECRETS_SERVERB=(SVRB_HOST SVRB_USERNAME SVRB_SSH_KEY)
          OPTIONAL_SECRETS=(SVRB_SSH_PORT SVRB_SUDO_PASSWORD WWW_UID WWW_GID DOCKERHUB_USERNAME DOCKERHUB_TOKEN)

          # æ£€æŸ¥ ServerB secretsï¼ˆå‰ç«¯åªéƒ¨ç½²åˆ° ServerBï¼‰
          echo ""
          echo "ðŸ“‹ Checking ServerB secrets (frontend deploys to ServerB only)..."
          for SECRET_NAME in "${REQUIRED_SECRETS_SERVERB[@]}"; do
            VALUE=${!SECRET_NAME}
            if [ -n "$VALUE" ]; then
              echo "âœ… $SECRET_NAME is set"
            else
              if [ $ENFORCE_REQUIRED -eq 1 ]; then
                echo "âŒ $SECRET_NAME is not set"
                VALIDATION_FAILED=1
              else
                echo "âš ï¸ $SECRET_NAME is not set (required when deploying to ServerB)"
              fi
            fi
          done

          echo ""
          echo "ðŸ“Ž Checking optional secrets (warnings only)..."
          for SECRET_NAME in "${OPTIONAL_SECRETS[@]}"; do
            VALUE=${!SECRET_NAME}
            if [ -n "$VALUE" ]; then
              echo "âœ… $SECRET_NAME is set"
            else
              case "$SECRET_NAME" in
                SVRB_SUDO_PASSWORD)
                  echo "âš ï¸ $SECRET_NAME is not set (needed only if sudo prompts for a password)"
                  ;;
                WWW_UID|WWW_GID)
                  echo "âš ï¸ $SECRET_NAME is not set (defaults to 1000/1000)"
                  ;;
                SVRB_SSH_PORT)
                  echo "âš ï¸ $SECRET_NAME is not set (defaults to 22)"
                  ;;
                DOCKERHUB_USERNAME|DOCKERHUB_TOKEN)
                  echo "âš ï¸ $SECRET_NAME is not set (Docker Hub push will be skipped)"
                  ;;
                *)
                  echo "âš ï¸ $SECRET_NAME is not set (optional)"
                  ;;
              esac
            fi
          done

          echo ""
          if [ $ENFORCE_REQUIRED -eq 1 ] && [ $VALIDATION_FAILED -eq 1 ]; then
            echo "âŒ Secrets validation failed! Please configure the missing required secrets."
            exit 1
          else
            echo "âœ… Required secrets look good (or not enforced for this branch)."
          fi

  # ==========================================================================
  # 2) Test / Lint / Build â€”â€” è·‘åœ¨ GitHub æ‰˜ç®¡ runner ä¸Š
  # ==========================================================================

  test:
    name: Run Tests
    needs: [validate-secrets]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: |
          npm test -- --coverage --watchAll=false --passWithNoTests || true
      
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-frontend
          fail_ci_if_error: false

  lint:
    name: Lint Code
    needs: [validate-secrets]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint
        run: |
          npx eslint . --ext .ts,.tsx,.js,.jsx --max-warnings 0 || echo "âš ï¸ Linting issues found (non-blocking)"

  build:
    name: Build Application
    needs: [test, lint]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build project
        env:
          NODE_OPTIONS: --openssl-legacy-provider
        run: npm run build
      
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: dist/
          retention-days: 7

  # ==========================================================================
  # 2.5) Docker æž„å»ºï¼ˆä½¿ç”¨ build/Dockerfileï¼‰
  # ==========================================================================

  docker-build:
    name: Build Docker Image
    needs: [test, lint]
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_REPOSITORY }}/qs-operating-system
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: build/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ==========================================================================
  # 3) éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨ â€”â€” Docker å®¹å™¨éƒ¨ç½²åˆ° ServerB
  #    å®¹å™¨åŠ å…¥ infra-network ç½‘ç»œ
  # ==========================================================================

  deploy-serverb:
    name: Deploy Docker Container to ServerB
    needs: [docker-build]
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == true)
    env:
      WWW_UID: ${{ secrets.WWW_UID || '1000' }}
      WWW_GID: ${{ secrets.WWW_GID || '1000' }}
      DEPLOY_PATH: ${{ secrets.DEPLOY_PATH_SERVERB || '/opt/qs-ops' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy Docker Container to ServerB
        uses: appleboy/ssh-action@v1.0.0
        env:
          DOCKER_REGISTRY: ${{ env.DOCKER_REGISTRY }}
          DOCKER_REPOSITORY: ${{ env.DOCKER_REPOSITORY }}
          SUDO_PASSWORD: ${{ secrets.SVRB_SUDO_PASSWORD }}
        with:
          host: ${{ secrets.SVRB_HOST }}
          username: ${{ secrets.SVRB_USERNAME }}
          key: ${{ secrets.SVRB_SSH_KEY }}
          port: ${{ secrets.SVRB_SSH_PORT || 22 }}
          envs: DOCKER_REGISTRY,DOCKER_REPOSITORY,SUDO_PASSWORD
          script: |
            set -Eeuo pipefail

            # SUDO åŠ©æ‰‹
            if sudo -n true 2>/dev/null; then
              SUDO="sudo"
              echo "â„¹ï¸ Using passwordless sudo."
            else
              if [ -z "${SUDO_PASSWORD:-}" ]; then
                echo "âŒ sudo needs password. Provide SVRB_SUDO_PASSWORD or configure NOPASSWD." >&2
                exit 1
              fi
              sudo_pw() { sudo -S "$@" <<<"$SUDO_PASSWORD"; }
              export -f sudo_pw
              SUDO="sudo_pw"
              $SUDO -v || true
              echo "â„¹ï¸ Using sudo with password."
            fi

            echo "=========================================="
            echo "Deploying Docker Container to ServerB"
            echo "=========================================="

            IMAGE_NAME="${DOCKER_REGISTRY}/${DOCKER_REPOSITORY}/qs-operating-system:latest"
            CONTAINER_NAME="qs-operating-system"
            NETWORK_NAME="infra-network"

            # ç™»å½•å®¹å™¨ä»“åº“ï¼ˆå¦‚æžœéœ€è¦ï¼‰
            echo "ðŸ” Checking container registry access..."
            # å¦‚æžœé•œåƒä»“åº“éœ€è¦è®¤è¯ï¼Œè¯·é…ç½®ç›¸åº”çš„ credentials
            # å¯¹äºŽ ghcr.ioï¼Œå¯ä»¥ä½¿ç”¨ Personal Access Token
            # echo "${REGISTRY_TOKEN}" | $SUDO docker login ${DOCKER_REGISTRY} -u ${REGISTRY_USERNAME} --password-stdin || true

            # æ‹‰å–æœ€æ–°é•œåƒ
            echo "ðŸ“¥ Pulling latest image: ${IMAGE_NAME}"
            $SUDO docker pull "${IMAGE_NAME}" || {
              echo "âŒ Failed to pull image. Make sure the image exists and credentials are correct."
              exit 1
            }

            # åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
            if $SUDO docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
              echo "ðŸ›‘ Stopping existing container..."
              $SUDO docker stop "${CONTAINER_NAME}" || true
              echo "ðŸ—‘ï¸ Removing existing container..."
              $SUDO docker rm "${CONTAINER_NAME}" || true
            fi

            # æ£€æŸ¥ç½‘ç»œæ˜¯å¦å­˜åœ¨
            if ! $SUDO docker network ls --format '{{.Name}}' | grep -q "^${NETWORK_NAME}$"; then
              echo "âŒ Network ${NETWORK_NAME} not found. Please create it first."
              exit 1
            fi

            # å¯åŠ¨æ–°å®¹å™¨å¹¶åŠ å…¥ infra-network
            echo "ðŸš€ Starting new container..."
            $SUDO docker run -d \
              --name "${CONTAINER_NAME}" \
              --network "${NETWORK_NAME}" \
              --restart unless-stopped \
              -p 3000:3000 \
              "${IMAGE_NAME}"

            # ç­‰å¾…å®¹å™¨å¯åŠ¨
            echo "â³ Waiting for container to be healthy..."
            sleep 5

            # éªŒè¯å®¹å™¨çŠ¶æ€
            if $SUDO docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
              echo "âœ… Container ${CONTAINER_NAME} is running"
              $SUDO docker ps --filter "name=${CONTAINER_NAME}" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
              
              # æ˜¾ç¤ºç½‘ç»œä¿¡æ¯
              echo ""
              echo "ðŸ“¡ Container network information:"
              $SUDO docker inspect "${CONTAINER_NAME}" --format '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' | xargs -I {} echo "  IP Address: {}"
            else
              echo "âŒ Container ${CONTAINER_NAME} failed to start"
              $SUDO docker logs "${CONTAINER_NAME}" || true
              exit 1
            fi

            echo "=========================================="
            echo "âœ… Docker container deployment completed"
            echo "=========================================="

  # ==========================================================================
  # 4) æ€»ä½“é€šçŸ¥
  # ==========================================================================

  notify:
    name: Send Notification
    needs: [deploy-serverb]
    runs-on: ubuntu-latest
    if: |
      always() && (
        (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
        (github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == true)
      )
    steps:
      - name: Log deployment status
        run: |
          echo "=========================================="
          echo "Deployment Summary"
          echo "=========================================="
          echo "ServerB: ${{ needs.deploy-serverb.result }}"

          if [ "${{ needs.deploy-serverb.result }}" = "success" ]; then
            echo "âœ… Deployment to ServerB succeeded"
          else
            echo "âŒ Deployment to ServerB failed"
            exit 1
          fi
